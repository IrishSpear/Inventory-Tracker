{% extends "base.html" %}
{% set title = "Reports" %}

{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="h4 mb-0">Reports</h2>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" href="{{ url_for('sales_csv') }}">Export Sales CSV</a>
      <a class="btn btn-outline-secondary" href="{{ url_for('tax_csv') }}">Export Tax CSV</a>
    </div>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="text-muted">Net Revenue (30d)</div>
          <div class="h5">{{ cents_to_money(summary.net_revenue_cents) }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="text-muted">Net Tax (30d)</div>
          <div class="h5">{{ cents_to_money(summary.net_tax_cents) }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="text-muted">Profit (30d)</div>
          <div class="h5">{{ cents_to_money(summary.profit_cents) }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="text-muted">Return Rate</div>
          <div class="h5">{{ (summary.return_rate * 100) | round(2) }}%</div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h3 class="h6">Daily Summary (30d)</h3>
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Day</th>
                <th>Sales</th>
                <th>Returns</th>
                <th>Revenue</th>
                <th>Refunds</th>
                <th>Net</th>
                <th>Net Tax</th>
              </tr>
            </thead>
            <tbody>
              {% for day, sales_count, return_count, revenue_cents, refund_cents, net_cents, net_tax_cents in daily %}
                <tr>
                  <td>{{ day }}</td>
                  <td>{{ sales_count }}</td>
                  <td>{{ return_count }}</td>
                  <td>{{ cents_to_money(revenue_cents) }}</td>
                  <td>{{ cents_to_money(refund_cents) }}</td>
                  <td>{{ cents_to_money(net_cents) }}</td>
                  <td>{{ cents_to_money(net_tax_cents) }}</td>
                </tr>
              {% else %}
                <tr>
                  <td colspan="7" class="text-center text-muted">No data.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h3 class="h6">Monthly Summary</h3>
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Month</th>
                <th>Net Revenue</th>
                <th>Net Tax</th>
                <th>Sales Count</th>
              </tr>
            </thead>
            <tbody>
              {% for month, net_rev, net_tax, sale_count in monthly %}
                <tr>
                  <td>{{ month }}</td>
                  <td>{{ cents_to_money(net_rev) }}</td>
                  <td>{{ cents_to_money(net_tax) }}</td>
                  <td>{{ sale_count }}</td>
                </tr>
              {% else %}
                <tr>
                  <td colspan="4" class="text-center text-muted">No data.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 mt-1">
    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h3 class="h6">Top Items</h3>
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Item</th>
                <th>Units</th>
                <th>Revenue</th>
                <th>Profit</th>
              </tr>
            </thead>
            <tbody>
              {% for title, units, revenue, profit in top_books %}
                <tr>
                  <td>{{ title }}</td>
                  <td>{{ units }}</td>
                  <td>{{ cents_to_money(revenue) }}</td>
                  <td>{{ cents_to_money(profit) }}</td>
                </tr>
              {% else %}
                <tr>
                  <td colspan="4" class="text-center text-muted">No data.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h3 class="h6">Top Platforms</h3>
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Platform</th>
                <th>Sales</th>
                <th>Revenue</th>
              </tr>
            </thead>
            <tbody>
              {% for platform, sales_count, revenue in top_platforms %}
                <tr>
                  <td>{{ platform }}</td>
                  <td>{{ sales_count }}</td>
                  <td>{{ cents_to_money(revenue) }}</td>
                </tr>
              {% else %}
                <tr>
                  <td colspan="3" class="text-center text-muted">No data.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 mt-1">
    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h3 class="h6">By Category</h3>
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Category</th>
                <th>Revenue</th>
                <th>Profit</th>
              </tr>
            </thead>
            <tbody>
              {% for category, revenue, profit in by_category %}
                <tr>
                  <td>{{ category }}</td>
                  <td>{{ cents_to_money(revenue) }}</td>
                  <td>{{ cents_to_money(profit) }}</td>
                </tr>
              {% else %}
                <tr>
                  <td colspan="3" class="text-center text-muted">No data.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h3 class="h6">Recent Returns</h3>
          <table class="table table-sm">
            <thead>
              <tr>
                <th>ID</th>
                <th>Date</th>
                <th>Receipt</th>
                <th>Refund</th>
                <th>Method</th>
              </tr>
            </thead>
            <tbody>
              {% for rid, created_at, receipt_no, refund_cents, method in returns_list %}
                <tr>
                  <td>{{ rid }}</td>
                  <td>{{ created_at }}</td>
                  <td>{{ receipt_no }}</td>
                  <td>{{ cents_to_money(refund_cents) }}</td>
                  <td>{{ method }}</td>
                </tr>
              {% else %}
                <tr>
                  <td colspan="5" class="text-center text-muted">No returns.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm mt-3">
    <div class="card-body">
      <h3 class="h6">Inventory Adjustments</h3>
      <table class="table table-sm">
        <thead>
          <tr>
            <th>Date</th>
            <th>Item</th>
            <th>Delta</th>
            <th>Reason</th>
            <th>User</th>
            <th>Note</th>
          </tr>
        </thead>
        <tbody>
          {% for created_at, title, delta, reason, note, username in adjustments %}
            <tr>
              <td>{{ created_at }}</td>
              <td>{{ title }}</td>
              <td>{{ delta }}</td>
              <td>{{ reason }}</td>
              <td>{{ username }}</td>
              <td>{{ note }}</td>
            </tr>
          {% else %}
            <tr>
              <td colspan="6" class="text-center text-muted">No adjustments.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% endblock %}
