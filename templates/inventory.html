{% extends "base.html" %}
{% set title = "Inventory" %}

{% block content %}
  <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3">
    <div>
      <a class="btn btn-primary" href="{{ url_for('book_new') }}">Add Item</a>
      <a class="btn btn-outline-secondary" href="{{ url_for('books_csv') }}">Export CSV</a>
    </div>
    {% if session.get('role') == 'admin' %}
    <form class="d-flex align-items-center gap-2" method="post" action="{{ url_for('books_import') }}" enctype="multipart/form-data">
      <input class="form-control form-control-sm" type="file" name="file" accept=".csv">
      <button class="btn btn-outline-primary btn-sm" type="submit">Import CSV</button>
    </form>
    {% endif %}
  </div>

  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <form class="row g-3">
        <div class="col-lg-4">
          <label class="form-label" for="search">Search</label>
          <input class="form-control" id="search" name="search" type="text" value="{{ search }}">
        </div>
        <div class="col-lg-2">
          <label class="form-label" for="condition">Condition</label>
          <select class="form-select" id="condition" name="condition">
            {% for option in conditions %}
              <option value="{{ option }}" {% if option == condition %}selected{% endif %}>{{ option }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-lg-2">
          <label class="form-label" for="availability">Availability</label>
          <select class="form-select" id="availability" name="availability">
            {% for value, label in availability_options %}
              <option value="{{ value }}" {% if value == availability %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-lg-4">
          <label class="form-label" for="category_id">Category</label>
          <select class="form-select" id="category_id" name="category_id">
            <option value="">All</option>
            {% for cid, name, _active in categories %}
              <option value="{{ cid }}" {% if cid == category_id %}selected{% endif %}>{{ name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-12 d-flex gap-3 align-items-center">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="in_stock" name="in_stock" value="1" {% if in_stock %}checked{% endif %}>
            <label class="form-check-label" for="in_stock">In stock only</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="low_stock" name="low_stock" value="1" {% if low_stock %}checked{% endif %}>
            <label class="form-check-label" for="low_stock">Low stock only</label>
          </div>
          <button class="btn btn-primary ms-auto" type="submit">Apply filters</button>
        </div>
      </form>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped align-middle">
          <thead>
            <tr>
              <th>Item</th>
              <th>Category</th>
              <th>Condition</th>
              <th>Availability</th>
              <th>Price</th>
              <th>Stock</th>
              <th>Reorder Point</th>
              <th>Location</th>
              <th>Barcode</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for row in rows %}
              <tr>
                <td>
                  <div class="fw-semibold">{{ row.title }}</div>
                  <div class="text-muted small">{{ row.author }}</div>
                </td>
                <td>{{ row.category }}</td>
                <td>{{ row.condition }}</td>
                <td>{{ row.availability }}</td>
                <td>{{ row.price }}</td>
                <td>{{ row.stock }}</td>
                <td>{{ row.reorder_point }}</td>
                <td>{{ row.location or "-" }}</td>
                <td>{{ row.barcode or row.isbn or "-" }}</td>
                <td>
                  {% if row.active %}
                    <span class="badge bg-success">Active</span>
                  {% else %}
                    <span class="badge bg-secondary">Archived</span>
                  {% endif %}
                </td>
                <td>
                  <div class="d-flex flex-wrap gap-1">
                    <a class="btn btn-sm btn-outline-primary" href="{{ url_for('book_edit', book_id=row.id) }}">Edit</a>
                    <form method="post" action="{{ url_for('book_toggle', book_id=row.id) }}">
                      <button class="btn btn-sm btn-outline-secondary" type="submit">Toggle</button>
                    </form>
                    {% if session.get('role') == 'admin' %}
                    <form method="post" action="{{ url_for('book_delete', book_id=row.id) }}">
                      <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
                    </form>
                    {% endif %}
                  </div>
                  <form class="mt-2" method="post" action="{{ url_for('book_adjust', book_id=row.id) }}">
                    <div class="input-group input-group-sm">
                      <input class="form-control" name="delta" type="number" placeholder="Adjust">
                      <input class="form-control" name="reason" type="text" placeholder="Reason">
                      <button class="btn btn-outline-primary" type="submit">Apply</button>
                    </div>
                  </form>
                </td>
              </tr>
            {% else %}
              <tr>
                <td colspan="11" class="text-center text-muted">No inventory matches those filters.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
{% endblock %}
